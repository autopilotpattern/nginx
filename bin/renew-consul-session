#!/usr/bin/env bash
CONSUL_HOST_DEFAULT="localhost"
if [ "${CONSUL_AGENT}" = "" -a "${CONSUL}" != "" ]; then
    CONSUL_HOST_DEFAULT=${CONSUL}
fi
CONSUL_HOST=${CONSUL_HOST:-$CONSUL_HOST_DEFAULT}

SESSION_DIR_DEFAULT="/var/consul"
SESSION_DIR=${SESSION_DIR:-$SESSION_DIR_DEFAULT}
SESSION_FILE=${SESSION_DIR}/session

function getSession () {
    if [ -f $SESSION_FILE ]; then 
        echo $(cat ${SESSION_DIR}/session)
    else
        echo ""
    fi
}

function renewSession () {
    local SID="$(getSession)"
    printf "Renewing Consul session ${SID}... "
    local STATUS=$(curl -s -o /dev/null -X PUT -w '%{http_code}' http://$CONSUL_HOST:8500/v1/session/renew/${SID})
    if [ "${STATUS}" = "200" ]; then
        echo "complete."
    else
        echo "failed."
        createSession
    fi
}

function createSession () {
    printf "Creating Consul session... "
    local SID=$(curl -sX PUT -d '{"LockDelay":"0s","Name":"acme-lock","Behavior":"release","TTL":"600s"}' http://127.0.0.1:8500/v1/session/create | awk -F  '"' '{print $4}')
    rc=$?; if [[ $rc != 0 ]]; then
        echo "failed."
    else
        echo $SID
        echo $SID > $SESSION_FILE
    fi
}

if [ -f $SESSION_FILE ]; then 
    renewSession
else
    createSession
fi

